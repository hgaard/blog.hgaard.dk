<!doctype html><html lang=en-US><head><title>Doing stuff with RethinkDB | The Bearded Code Monkey</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="I recently started a new job. Actually I moved from Copenhagen to Brisbane, Australia with my whole family, just to try living and working in a different country - and of course to give our 3 kids and ourselves a great experience/ adventure. Anyway, I got a job in the Australian consultancy Readify and one of the perks there is PD or Professional Development for up to 20 days a year. 20 days where I can work with/learn whatever I feel like (well almost. I need to justify the relevance of the topic and I have to produce something that my colleagues can benefit from too). Yeah I know pretty sweet! So the last 2 days I have had my first PD and my goal was to get familiar with RethinkDB."><meta name=generator content="Hugo 0.151.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/blog>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a>
<a href=https://resume.hgaard.com>Resume</a>
<a class=button href=/index.xml>Subscribe</a></nav><main class=main><section id=single><h1 class=title>Doing stuff with RethinkDB</h1><div class=tip><time datetime="2016-08-04 00:00:00 +0000 UTC">Aug 4, 2016</time>
<span class=split>¬∑
</span><span>1534 words
</span><span class=split>¬∑
</span><span>8 minute read</span></div><aside class=toc><details><summary>Table of Contents</summary><div><nav id=TableOfContents><ul><li><a href=#what-is-rethinkdb>What is RethinkDB</a><ul><li><a href=#why-should-i-care>Why should I care</a></li></ul></li><li><a href=#what-did-i-want-to-do>What did I want to do</a><ul><li><a href=#how-did-i-do-it-and-how-to-get-started>How did I do it and how to get started.</a></li></ul></li><li><a href=#notes-on-the-development-experience>Notes on the development experience</a></li><li><a href=#questions>Questions</a></li><li><a href=#useful-resources>Useful resources</a></li></ul></nav></div></details></aside><div class=content><p>I recently started a new job. Actually I moved from Copenhagen to Brisbane, Australia with my whole family, just to try living and working in a different country - and of course to give our 3 kids and ourselves a great experience/ adventure. Anyway, I got a job in the Australian consultancy <a href=http://readify.net target=_blank rel=noopener>Readify</a> and one of the perks there is PD or Professional Development for up to 20 days a year. 20 days where I can work with/learn whatever I feel like (well almost. I need to justify the relevance of the topic and I have to produce something that my colleagues can benefit from too). Yeah I know pretty sweet! So the last 2 days I have had my first PD and my goal was to get familiar with <a href=https://www.rethinkdb.com/ target=_blank rel=noopener>RethinkDB</a>.</p><p>Well the above is not completely true anymore. I started out writing this post when I actually did my PD, but it turns out it takes time writing stuff. Well, months have passed but here we go:</p><h2 id=what-is-rethinkdb>What is RethinkDB <a href=#what-is-rethinkdb class=anchor>üîó</a></h2><p>From <a href=http://rethinkdb.com target=_blank rel=noopener>RethinkDB</a>:</p><blockquote><p>RethinkDB is the first open-source, scalable JSON database built from the ground up for the realtime web. It inverts the traditional database architecture by exposing an exciting new access model ‚Äì instead of polling for changes, the developer can tell RethinkDB to continuously push updated query results to applications in realtime. RethinkDB‚Äôs realtime push architecture dramatically reduces the time and effort necessary to build scalable realtime apps</p></blockquote><p>A few things to highlight here: Yeah, it is just a document DB, but with the access model kinda turned on it&rsquo;s head. This means that there is no longer a need to poll the database for updates in specific tables, they will just get pushed directly to you. In fact you can subscribe to chances for any query you write and these changes will be pushed directly to your app. That is, I think, very very powerful! RethinkDB also supports things like joins, subqueries, geo queries and map-reduce. On top of this, the fact that it is built as a distributed system, just makes it all the more interesting.</p><p><strong>Update</strong></p><p><em>As Henrik Andersson has pointed out in the comments, I was incorrect about what kind of queries change feeds can be applied to. It is for instance not yet possible to apply change feeds to joins. For a complete description of change feeds have a look at their description <a href=https://rethinkdb.com/docs/changefeeds/ruby/ target=_blank rel=noopener>here</a></em></p><h3 id=why-should-i-care>Why should I care <a href=#why-should-i-care class=anchor>üîó</a></h3><p>First of all think about any time you would push stuff, either to a mobile phone or to a browser. How do you usually handle that? A pattern I see very often these days in applications, where we want to ensure that all users are up to date, is the use of event/message aggregators or internal busses, where the code that writes to the database, also triggers a message to the event aggregator/bus. For these scenarios integrating RethinkDB would render the bus/aggregator redundant. Event subscribers would simply subscribe to a query in the database instead.</p><p>Other examples could be any collaborative applications where users look at the same data, IoT or just plain Pub/Sub scenarios.</p><h2 id=what-did-i-want-to-do>What did I want to do <a href=#what-did-i-want-to-do class=anchor>üîó</a></h2><p>OK, RethinkDB is some interesting tech and I wanted to get to know it little better. I decided that a logging dashboard would serve as a good example app. A simple website displaying log messages from other systems and updating the dashboard instantly when new messages arrive, simples!</p><h3 id=how-did-i-do-it-and-how-to-get-started>How did I do it and how to get started. <a href=#how-did-i-do-it-and-how-to-get-started class=anchor>üîó</a></h3><p>First of all, to get started with RethinkDB I needed to have it on my machine. I was on Windows for this one, so I just downloaded the latest version <a href=https://www.rethinkdb.com/docs/install/windows/ target=_blank rel=noopener>here</a> and added to my tools folder (which is already in my PATH). Staring RethinkDB on windows is just running the <code>rethinkdb.exe</code> file. The data will by default be located in the same folder as where RethinkDB is started from. So to use a specific path for the data you would start RethinkDB with the <code>-d</code> switch and provide a path.</p><h4 id=the-driver>The Driver <a href=#the-driver class=anchor>üîó</a></h4><p>In order to connect to the database I will need a driver for it. RethinkDB officially supports drivers for JavaScript, Python, Ruby and Java, but there are community developed drivers for heaps of other <a href=https://www.rethinkdb.com/docs/install-drivers/ target=_blank rel=noopener>languages</a> too. I&rsquo;ll be writing in C#, and luckily there is a community driver for that. Actually there are two with slightly different approach to solving the problem. I picked the one maintained by <a href=https://github.com/bchavez/RethinkDb.Driver target=_blank rel=noopener>bchavez</a>. It seeks to follow the official Java driver and extends it with a more C#-ish syntax and a Linq layer. The Linq part I think is especially cool since it took a bit of time for me to internalize the default syntax.</p><h4 id=writing-queries-and-subscribing-to-feeds>Writing queries and subscribing to feeds. <a href=#writing-queries-and-subscribing-to-feeds class=anchor>üîó</a></h4><p>To get a feel for the database and the <a href=https://www.rethinkdb.com/docs/introduction-to-reql/ target=_blank rel=noopener>ReQL</a> query language I started out writing simple queries from LinqPad (I have a few examples <a href=https://github.com/hgaard/RethinkLogs/tree/master/query-samples target=_blank rel=noopener>here</a>). RethinkDB also comes with a dashboard (running on localhost port 8080) that has a <em>data explorer</em> where you can write queries in the native ReQL language (JavaScript/JSON). The data explorer provides an intellisense-like experience, that proved really helpful for discovering the API surface.</p><p><p class=markdown-image><img src=/../images/rethinkdb-console-api.png alt="Image of a console example query"></p></p><h4 id=writing-the-app>Writing the app <a href=#writing-the-app class=anchor>üîó</a></h4><p>In order to focus on the dashboard of the app I used <a href=https://serilog.net/ target=_blank rel=noopener>Serilog</a> and the Serilog <a href=https://github.com/serilog/serilog-sinks-rethinkdb target=_blank rel=noopener>RethinkDB Sink</a> to produce some &ldquo;real&rdquo; log entries.</p><p>The simple dashboard I wanted to build would just query a single table in the database and send that back to the browser.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> result = R.Db(Constants.LoggingDatabase).Table(LoggingTable)
</span></span><span style=display:flex><span>                .OrderBy(R.Desc(<span style=color:#e6db74>&#34;Timestamp&#34;</span>))
</span></span><span style=display:flex><span>                .Limit(<span style=color:#ae81ff>50</span>)
</span></span><span style=display:flex><span>                .OrderBy(<span style=color:#e6db74>&#34;Timestamp&#34;</span>)
</span></span><span style=display:flex><span>                .RunResult&lt;IList&lt;LogEvent&gt;&gt;(_connection);
</span></span></code></pre></div><p>This will the return latest 50 entries from the <code>LoggingTable</code>. The generic <code>RunResults</code> will serialize the results back in a list of <code>LogEvent</code>&rsquo;s. I&rsquo;ll be using a query like that for the initial loading of the system.</p><p>In order to have updates streamed back to the app from the database I will have to subscribe to a change feed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>    <span style=color:#66d9ef>var</span> feed = R.Db(Constants.LoggingDatabase)
</span></span><span style=display:flex><span>                .Table(Constants.LoggingTable)
</span></span><span style=display:flex><span>                .Changes()
</span></span><span style=display:flex><span>                .RunChanges&lt;LogEvent&gt;(connection);
</span></span></code></pre></div><p>This will return a <strong>cursor</strong> object which in turn will return all updates for the query it represents. Think of the cursor as an IObservable collection. The generic <code>RunChanges&lt;LogEvent></code> will ensure that the results are returned as LogEvent objects. The driver also has a non generic version of the <code>RunChanges()</code> method which will return results as <code>dynamic</code>. The objects that are pushed to the client is actually not only changes, but rather 2 objects, the new state and the one before that.</p><h4 id=putting-it-all-together>Putting it all together <a href=#putting-it-all-together class=anchor>üîó</a></h4><p>So for the logging dashboard, I wanted to subscribe to all changes from the logging table, and then push these to all clients (dashboard clients). For this I used SignalR. Adding this to the change query above, it looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> HandleUpdates(IConnectionManager connectionManager)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> hub = connectionManager.GetHubContext&lt;LogHub&gt;();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> connection = R.Connection()
</span></span><span style=display:flex><span>                        .Hostname(Constants.Host)
</span></span><span style=display:flex><span>                        .Port(Constants.Port)
</span></span><span style=display:flex><span>                        .Connect();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> feed = R.Db(Constants.LoggingDatabase)
</span></span><span style=display:flex><span>                    .Table(Constants.LoggingTable)
</span></span><span style=display:flex><span>                    .Changes()
</span></span><span style=display:flex><span>                    .RunChanges&lt;LogEvent&gt;(connection);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        feed.Select(x =&gt; hub.Clients.All.onMessage(x.NewValue)).ToList();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>A final detail worth mentioning is that in order to ensure a long lived feed/cursor, I run the query as a long running task separate from the dashboard itself.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>      Task.Factory.StartNew(() =&gt;
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>          LogHub.HandleUpdates(connManager);
</span></span><span style=display:flex><span>      }, TaskCreationOptions.LongRunning);
</span></span></code></pre></div><p>You can find the complete sample application with (some basic) getting started instructions on <a href=https://github.com/hgaard/rethinklogs target=_blank rel=noopener>Github</a> including simple LinqPad query examples.</p><h2 id=notes-on-the-development-experience>Notes on the development experience <a href=#notes-on-the-development-experience class=anchor>üîó</a></h2><p>First of all I have to say that the official documentation on RethinkDB is excellent and very elaborate. It is usually very easy to find answers and even googling for something usually takes you to their own documentation. It also has a very good description of their overall architecture and their architectural decisions. A good example of this of the description of the trade-off&rsquo;s they have made in regards to the <a href=https://www.rethinkdb.com/docs/architecture/#cap-theorem target=_blank rel=noopener>CAP theorem</a>.</p><p>Another interesting note is the <a href=https://aphyr.com/posts/330-jepsen-rethinkdb-2-2-3-reconfiguration target=_blank rel=noopener>Jepsen tests</a> on distributes systems correctness. It seems to indicate that the RethinkDB team has a good grip on the distributed part of building databases and are very responsive when it comes to solving problems.</p><h2 id=questions>Questions <a href=#questions class=anchor>üîó</a></h2><p>I also gave a lightning talk (slides <a href=https://speakerdeck.com/hgaard/introduction-to-rethinkdb target=_blank rel=noopener>here</a>) on this topic at out last <a href=https://twitter.com/mouna1619/status/733515269109243907 target=_blank rel=noopener>Back2Base</a> event at Readify. Some of my colleagues asked a few good follow up questions that I thought I might share here too.</p><p><strong>What concurrency model is used?</strong></p><p>From the RethinkDB <a href=http://rethinkdb.com/blog/lock-free-vs-wait-free-concurrency/ target=_blank rel=noopener>blog</a> there is and explanation of how RethinkDB implements a lock-free system. The tl;dr of the is;</p><blockquote><p>Lock-free algorithms increase the overall throughput of a system by occasionally increasing the latency of a particular transaction. Most high- end database systems are based on lock-free algorithms, to varying degrees</p></blockquote><p>From a <a href=http://www.rethinkdb.com/docs/architecture/#how-does-rethinkdb-execute-queries target=_blank rel=noopener>architecture documentation</a>, there is a more in depth description of concurrency control.</p><p><strong>Would I user it production?</strong></p><p>The answer I gave at Back2Base was, that for something like dashboarding yes. RethinkDB seems very mature and has a fast growing community around it. For &ldquo;regular&rdquo; documentDB stuff, I can&rsquo;t really say. Mostly because I haven&rsquo;t used other documentDB/NoSql in important production scenarios i.e., I haven&rsquo;t felt the pains, and it is therefore difficult to compare the experience. But looking at the architectural decisions, the Jepsen tests and the community around RethinkDB, I would certainty not hesitate to give it a try.</p><h2 id=useful-resources>Useful resources <a href=#useful-resources class=anchor>üîó</a></h2><ul><li>RethinkDB <a href=https://www.rethinkdb.com/docs target=_blank rel=noopener>documentation</a></li><li>RethinkDB <a href=https://github.com/bchavez/RethinkDb.Driver target=_blank rel=noopener>Driver</a> by Brian Chavez</li><li>Pluralsight - <a href=https://www.pluralsight.com/courses/rethinkdb-fundamentals target=_blank rel=noopener>RethinkDB fundamentals</a> by Rob Conery</li><li>The <a href=https://changelog.com/181/ target=_blank rel=noopener>Changelog episode</a> with Slava Akhmechet</li></ul></div><div class=tags><a href=https://blog.hgaard.com/tags/rethinkdb>RethinkDB</a>
<a href=https://blog.hgaard.com/tags/nosql>NoSql</a>
<a href=https://blog.hgaard.com/tags/getting-started>Getting Started</a>
<a href=https://blog.hgaard.com/tags/realtime>Realtime</a></div><div id=comment><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hgaard.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></main><footer id=footer><div id=social><a class=symbol href=https://github.com/hgaard rel=me target=_blank><svg fill="#bbb" width="28" height="28" viewBox="0 0 72 72" xmlns:xlink="http://www.w3.org/1999/xlink"><title>Github</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)"><g id="Github" transform="translate(264.000000, 939.000000)"><path d="M8 72H64c4.418278.0 8-3.581722 8-8V8c0-4.418278-3.581722-8-8-8H8c-4.418278 811624501e-24-8 3.581722-8 8V64c541083001e-24 4.418278 3.581722 8 8 8z" id="Rounded" fill="#bbb"/><path d="M35.9985 13C22.746 13 12 23.7870921 12 37.096644c0 10.6440272 6.876 19.6751861 16.4145 22.8617681C29.6145 60.1797862 30.0525 59.4358488 30.0525 58.7973276 30.0525 58.2250681 30.0315 56.7100863 30.0195 54.6996482c-6.6765 1.4562499-8.085-3.2302544-8.085-3.2302544-1.0905-2.7829884-2.664-3.5239139-2.664-3.5239139C17.091 46.4500754 19.4355 46.4801943 19.4355 46.4801943c2.4075.1701719 3.675 2.4833051 3.675 2.4833051 2.142 3.6820383 5.6175 2.6188404 6.9855 2.0014024C30.3135 49.4077535 30.9345 48.3460615 31.62 47.7436831 26.2905 47.1352808 20.688 45.0691228 20.688 35.8361671c0-2.6308879.9345-4.781379 2.4705-6.4665327C22.911 28.7597262 22.0875 26.3110578 23.3925 22.9934585c0 0 2.016-.6475568 6.6 2.4697516C31.908 24.9285993 33.96 24.6620468 36.0015 24.6515052 38.04 24.6620468 40.0935 24.9285993 42.0105 25.4632101c4.581-3.1173084 6.5925-2.4697516 6.5925-2.4697516C49.9125 26.3110578 49.089 28.7597262 48.8415 29.3696344 50.3805 31.0547881 51.309 33.2052792 51.309 35.8361671c0 9.2555448-5.6115 11.29309-10.9575 11.8894446.860999999999997.7439374 1.629 2.2137408 1.629 4.4621184C41.9805 55.4089489 41.9505 58.0067059 41.9505 58.7973276 41.9505 59.4418726 42.3825 60.1918338 43.6005 59.9554002 53.13 56.7627944 60 47.7376593 60 37.096644 60 23.7870921 49.254 13 35.9985 13" fill="#FFF"/></g></g></g></svg>
</a><a class=symbol href=https://www.linkedin.com/in/jakobhojgaard/ rel=me target=_blank><svg width="28" height="28" fill="#bbb" viewBox="0 0 500 500"><g fill="none" fill-rule="evenodd"><rect width="500" height="500" fill="#bbb" rx="50"/><path fill="#FFF" d="M154.703 100.183c-19.121.0-34.689 15.565-34.703 34.701.0 19.136 15.568 34.704 34.703 34.704 19.128.0 34.688-15.568 34.688-34.704.0-19.134-15.561-34.701-34.688-34.701zm26.045 83.348h-52.094a4.488 4.488.0 00-4.488 4.489v167.675a4.488 4.488.0 004.488 4.488h52.093a4.49 4.49.0 004.489-4.488V188.02a4.486 4.486.0 00-4.488-4.489zm133.176-1.974c-19.064.0-35.817 5.805-46.04 15.271v-8.808c0-2.48-2.01-4.489-4.489-4.489h-49.971a4.489 4.489.0 00-4.489 4.489v167.675a4.488 4.488.0 004.489 4.488h52.044a4.49 4.49.0 004.489-4.488v-82.957c0-23.802 4.378-38.555 26.227-38.555 21.526.026 23.137 15.846 23.137 39.977v81.535a4.489 4.489.0 004.49 4.488h52.068a4.489 4.489.0 004.488-4.488v-91.977c-.001-38.253-7.553-82.161-66.443-82.161z"/></g></svg>
</a><a class=symbol href=https://twitter.com/hgaard rel=me target=_blank><svg fill="#bbb" width="28" height="28" id="Capa_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="438.536" height="438.536" viewBox="0 0 438.536 438.536" style="enable-background:new 0 0 438.536 438.536"><g><path d="M414.41 24.123C398.333 8.042 378.963.0 356.315.0H82.228C59.58.0 40.21 8.042 24.126 24.123 8.045 40.207.003 59.576.003 82.225v274.084c0 22.647 8.042 42.018 24.123 58.102 16.084 16.084 35.454 24.126 58.102 24.126h274.084c22.648.0 42.018-8.042 58.095-24.126 16.084-16.084 24.126-35.454 24.126-58.102V82.225C438.532 59.576 430.49 40.204 414.41 24.123zM335.471 168.735c.191 1.713.288 4.278.288 7.71.0 15.989-2.334 32.025-6.995 48.104-4.661 16.087-11.8 31.504-21.416 46.254-9.606 14.749-21.074 27.791-34.396 39.115-13.325 11.32-29.311 20.365-47.968 27.117-18.648 6.762-38.637 10.143-59.953 10.143-33.116.0-63.76-8.952-91.931-26.836 4.568.568 9.329.855 14.275.855 27.6.0 52.439-8.565 74.519-25.7-12.941-.185-24.506-4.179-34.688-11.991-10.185-7.803-17.273-17.699-21.271-29.691 4.947.76 8.658 1.137 11.132 1.137 4.187.0 9.042-.76 14.56-2.279-13.894-2.669-25.598-9.562-35.115-20.697-9.519-11.136-14.277-23.84-14.277-38.114v-.571c10.085 4.755 19.602 7.229 28.549 7.422-17.321-11.613-25.981-28.265-25.981-49.963.0-10.66 2.758-20.747 8.278-30.264 15.035 18.464 33.311 33.213 54.816 44.252 21.507 11.038 44.54 17.227 69.092 18.558-.95-3.616-1.427-8.186-1.427-13.704.0-16.562 5.853-30.692 17.56-42.399 11.703-11.706 25.837-17.561 42.394-17.561 17.515.0 32.079 6.283 43.688 18.846 13.134-2.474 25.892-7.33 38.26-14.56-4.757 14.652-13.613 25.788-26.55 33.402 12.368-1.716 23.88-4.95 34.537-9.708C357.458 149.793 347.462 160.166 335.471 168.735z"/></g></svg></a></div><div class=copyright>¬© Jakob H√∏jgaard</div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>